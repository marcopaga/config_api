name: Specification Validation

on:
  push:
    branches: [ main, feature/*, develop ]
    paths:
      - 'spec/**'
      - 'lib/**'
      - 'test/spec/**'
      - '.github/workflows/spec-validation.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'spec/**'
      - 'lib/**'
      - 'test/spec/**'

jobs:
  # Shared setup job for Node.js dependencies
  setup-node-tools:
    name: Setup Node.js Tools
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Cache node_modules
        uses: actions/cache/save@b7e8d49f17405cc70c1c120101943203c98d3a4b # v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('package-lock.json') }}

  validate-openapi:
    name: Validate OpenAPI Specification
    runs-on: ubuntu-latest
    needs: setup-node-tools

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: '20'

      - name: Restore node_modules cache
        uses: actions/cache/restore@b7e8d49f17405cc70c1c120101943203c98d3a4b # v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('package-lock.json') }}

      - name: Validate OpenAPI spec
        run: npx redocly lint spec/openapi/configapi-v1.yaml

      - name: Generate documentation
        run: npx redocly build-docs spec/openapi/configapi-v1.yaml -o docs/api-reference.html

      - name: Upload API documentation
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: api-documentation
          path: docs/api-reference.html
          retention-days: 30

  validate-json-schema:
    name: Validate JSON Schemas
    runs-on: ubuntu-latest
    needs: setup-node-tools

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: '20'

      - name: Restore node_modules cache
        uses: actions/cache/restore@b7e8d49f17405cc70c1c120101943203c98d3a4b # v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('package-lock.json') }}

      - name: Validate all JSON schemas
        run: npm run validate:json-schema

  validate-asyncapi:
    name: Validate AsyncAPI Specification
    runs-on: ubuntu-latest
    needs: setup-node-tools

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: '20'

      - name: Restore node_modules cache
        uses: actions/cache/restore@b7e8d49f17405cc70c1c120101943203c98d3a4b # v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('package-lock.json') }}

      - name: Validate AsyncAPI spec
        run: npm run validate:asyncapi

  contract-tests:
    name: Contract Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:14-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: config_api_eventstore_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Elixir
        uses: erlef/setup-beam@5304e04ea2b355f03681464e683d92e3b2f18451 # v1.18.2
        with:
          otp-version: '28.0.2'
          elixir-version: '1.18.4'

      - name: Restore dependencies cache
        uses: actions/cache@b7e8d49f17405cc70c1c120101943203c98d3a4b # v4
        with:
          path: |
            deps
            _build/test
          key: ${{ runner.os }}-mix-otp28-elixir1.18-test-${{ hashFiles('**/mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-mix-otp28-elixir1.18-test-
            ${{ runner.os }}-mix-otp28-elixir1.18-

      - name: Install dependencies
        run: mix deps.get

      - name: Initialize EventStore
        run: |
          mix event_store.create
          mix event_store.init
        env:
          MIX_ENV: test
          EVENTSTORE_HOST: localhost
          EVENTSTORE_PORT: 5432
          EVENTSTORE_DATABASE: config_api_eventstore_test
          EVENTSTORE_USERNAME: postgres
          EVENTSTORE_PASSWORD: postgres

      - name: Run contract tests
        run: mix test test/spec/
        env:
          MIX_ENV: test
          EVENTSTORE_HOST: localhost
          EVENTSTORE_PORT: 5432
          EVENTSTORE_DATABASE: config_api_eventstore_test
          EVENTSTORE_USERNAME: postgres
          EVENTSTORE_PASSWORD: postgres

      - name: Upload test results
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        if: failure()
        with:
          name: contract-test-results
          path: |
            **/*.log
            _build/test/**/*.log
          retention-days: 7
          if-no-files-found: ignore

  specification-report:
    name: Generate Specification Report
    runs-on: ubuntu-latest
    needs: [validate-openapi, validate-json-schema, validate-asyncapi, contract-tests]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Create specification summary
        run: |
          echo "# Specification Validation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Files Validated" >> $GITHUB_STEP_SUMMARY
          echo "- OpenAPI 3.1: \`spec/openapi/configapi-v1.yaml\`" >> $GITHUB_STEP_SUMMARY
          echo "- JSON Schemas: 3 files in \`spec/json-schema/\`" >> $GITHUB_STEP_SUMMARY
          echo "- AsyncAPI 3.0: \`spec/asyncapi/config-events-v1.yaml\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Validation Status" >> $GITHUB_STEP_SUMMARY
          echo "- OpenAPI: ${{ needs.validate-openapi.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- JSON Schema: ${{ needs.validate-json-schema.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- AsyncAPI: ${{ needs.validate-asyncapi.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Contract Tests: ${{ needs.contract-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Specification Files" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          find spec -type f | sort >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
