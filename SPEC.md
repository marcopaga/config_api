# ConfigApi API Specifications

**Version:** 1.0.0
**Architecture:** CQRS with Event Sourcing
**Specification Standards:** OpenAPI 3.1, JSON Schema 2020-12, AsyncAPI 3.0

## Overview

ConfigApi provides comprehensive machine-readable API specifications for all interfaces, events, and data models. The specifications enable automated client generation, contract testing, documentation generation, and integration with external systems.

### Specification Types

| Type | Standard | Purpose | Location |
|------|----------|---------|----------|
| **REST API** | OpenAPI 3.1.0 | HTTP endpoint contracts | `spec/openapi/` |
| **Domain Events** | JSON Schema 2020-12 | Event structure validation | `spec/json-schema/events/` |
| **Aggregates** | JSON Schema 2020-12 | Aggregate state schemas | `spec/json-schema/aggregates/` |
| **Event Streaming** | AsyncAPI 3.0.0 | Event-driven architecture | `spec/asyncapi/` |

## Architecture: CQRS with Event Sourcing

ConfigApi implements the CQRS (Command Query Responsibility Segregation) pattern with Event Sourcing, providing:

### Write Path (Commands)
```
HTTP PUT/DELETE → Aggregate → Event → EventStore → Projection
                     ↓
                 Validation
```

- **Aggregates** validate commands and generate events
- **Events** are immutable and append-only
- **EventStore** persists events to PostgreSQL
- **Projections** update synchronously for immediate consistency

### Read Path (Queries)
```
HTTP GET → Projection (ETS) → Response
```

- **Sub-millisecond** query performance
- **In-memory** ETS table for fast reads
- **Immediate consistency** with write path

### Event Sourcing
```
EventStore → Event Stream → Time Travel Queries
             ↓
         Audit Trail
```

- Complete audit trail of all changes
- Point-in-time state reconstruction
- Event replay capabilities

## OpenAPI 3.1 Specification

### File Structure

```
spec/openapi/
├── configapi-v1.yaml              # Main OpenAPI specification
├── paths/                         # Endpoint definitions
│   ├── health.yaml                # Health check endpoint
│   ├── config.yaml                # List configurations (query)
│   ├── config-item.yaml           # CRUD operations (command/query)
│   ├── history.yaml               # Event history (query)
│   └── time-travel.yaml           # Point-in-time query
├── schemas/                       # Data models
│   ├── requests.yaml              # Request schemas
│   ├── responses.yaml             # Response schemas
│   ├── errors.yaml                # Error schemas
│   └── health.yaml                # Health response schema
├── parameters/
│   └── path.yaml                  # Reusable path parameters
└── examples/
    ├── config-operations.yaml     # Request/response examples
    └── event-history.yaml         # Event examples
```

### API Endpoints

#### Health & Status

| Endpoint | Method | Description | CQRS Pattern |
|----------|--------|-------------|--------------|
| `/v1/health` | GET | Service health check | N/A |

#### Configuration Management

| Endpoint | Method | Description | CQRS Pattern |
|----------|--------|-------------|--------------|
| `/v1/config` | GET | List all configurations | Query |
| `/v1/config/{name}` | GET | Get configuration value | Query |
| `/v1/config/{name}` | PUT | Set configuration value | Command |
| `/v1/config/{name}` | DELETE | Delete configuration | Command |

#### Event Sourcing Queries

| Endpoint | Method | Description | CQRS Pattern |
|----------|--------|-------------|--------------|
| `/v1/config/{name}/history` | GET | Get event history | Query (EventStore) |
| `/v1/config/{name}/at/{timestamp}` | GET | Time-travel query | Query (Event Replay) |

### CQRS Annotations

The OpenAPI specification includes custom extensions documenting CQRS architecture:

```yaml
x-cqrs-pattern: command          # command, query, or event
x-aggregate: ConfigValue         # Aggregate handling the operation
x-generates-event: ConfigValueSet # Event generated by command
x-read-from: projection          # projection or eventstore
x-consistency: immediate         # immediate or eventual
```

### Validation

```bash
# Validate OpenAPI specification
npx redocly lint spec/openapi/configapi-v1.yaml

# Expected output: Valid specification with 6 warnings (example URLs)
```

### Generate Documentation

```bash
# Generate interactive HTML documentation
npx redocly build-docs spec/openapi/configapi-v1.yaml -o docs/api-reference.html

# Serve with live preview
npx redoc-cli serve spec/openapi/configapi-v1.yaml
# Open http://localhost:8080
```

### Generate API Clients

```bash
# TypeScript client
npx @openapitools/openapi-generator-cli generate \
  -i spec/openapi/configapi-v1.yaml \
  -g typescript-fetch \
  -o clients/typescript

# Python client
npx @openapitools/openapi-generator-cli generate \
  -i spec/openapi/configapi-v1.yaml \
  -g python \
  -o clients/python

# Go client
npx @openapitools/openapi-generator-cli generate \
  -i spec/openapi/configapi-v1.yaml \
  -g go \
  -o clients/go
```

## JSON Schema Specifications

### Event Schemas

Domain events represent state changes in the system:

#### ConfigValueSet Event

**File:** `spec/json-schema/events/config-value-set.json`

```json
{
  "config_name": "api_key",
  "value": "secret123",
  "metadata": {
    "user_id": "user@example.com",
    "timestamp": "2024-01-15T10:30:00Z"
  }
}
```

**Properties:**
- `config_name` (string, required): Configuration key
- `value` (string, required): Configuration value
- `metadata` (object, optional): Event metadata

#### ConfigValueDeleted Event

**File:** `spec/json-schema/events/config-value-deleted.json`

```json
{
  "config_name": "api_key",
  "metadata": {
    "user_id": "user@example.com",
    "timestamp": "2024-01-15T11:00:00Z"
  }
}
```

**Properties:**
- `config_name` (string, required): Configuration key to delete
- `metadata` (object, optional): Event metadata

### Aggregate Schemas

#### ConfigValue Aggregate

**File:** `spec/json-schema/aggregates/config-value.json`

Represents the current state of a configuration value aggregate:

```json
{
  "name": "api_key",
  "value": "secret123",
  "version": 5,
  "deleted": false,
  "created_at": "2024-01-15T10:30:00Z",
  "updated_at": "2024-01-15T12:45:00Z"
}
```

**Properties:**
- `name` (string): Configuration name
- `value` (string): Current value (null if deleted)
- `version` (integer): Event version number
- `deleted` (boolean): Deletion flag
- `created_at` (string, ISO8601): Creation timestamp
- `updated_at` (string, ISO8601): Last update timestamp

### Validation

```bash
# Validate JSON schemas
npx ajv compile -s spec/json-schema/events/config-value-set.json --strict=false
npx ajv compile -s spec/json-schema/events/config-value-deleted.json --strict=false
npx ajv compile -s spec/json-schema/aggregates/config-value.json --strict=false

# All schemas: JSON Schema 2020-12 compliant
```

### Usage in Code

```elixir
# Validate event against schema
alias ConfigApi.Events.ConfigValueSet
alias ExJsonSchema.Validator

{:ok, schema} =
  "spec/json-schema/events/config-value-set.json"
  |> File.read!()
  |> Jason.decode!()

event = ConfigValueSet.new("api_key", "secret123", nil)
event_map = Map.from_struct(event)

case Validator.validate(schema, event_map) do
  :ok -> {:ok, event}
  {:error, errors} -> {:error, errors}
end
```

## AsyncAPI 3.0 Specification

### Event Streaming Architecture

**File:** `spec/asyncapi/config-events-v1.yaml`

Documents the event-driven architecture and message flows:

```yaml
channels:
  config-events:
    address: config-events
    messages:
      ConfigValueSet:
        payload:
          $ref: '../json-schema/events/config-value-set.json'
      ConfigValueDeleted:
        payload:
          $ref: '../json-schema/events/config-value-deleted.json'
```

### Operations

| Operation | Type | Description |
|-----------|------|-------------|
| `publishConfigEvent` | Send | Publish configuration change events |
| `subscribeConfigEvents` | Receive | Subscribe to configuration events |

### Validation

```bash
# Validate AsyncAPI specification
npx asyncapi validate spec/asyncapi/config-events-v1.yaml

# Expected output: Valid AsyncAPI 3.0.0 specification
```

### Generate Event Documentation

```bash
# Generate HTML documentation
npx asyncapi generate fromTemplate \
  spec/asyncapi/config-events-v1.yaml \
  @asyncapi/html-template \
  -o docs/asyncapi

# Open documentation
open docs/asyncapi/index.html
```

## Contract Testing

### Automated Validation

Contract tests ensure the implementation matches specifications:

```bash
# Run all specification tests
mix test test/spec/

# Individual test suites
mix test test/spec/openapi_contract_test.exs    # OpenAPI contract tests
mix test test/spec/event_schema_test.exs        # JSON Schema validation
mix test test/spec/spec_validation_test.exs     # Spec file validation
```

### Test Coverage

| Test Suite | Tests | Description |
|------------|-------|-------------|
| `openapi_contract_test.exs` | 25 | HTTP contract validation |
| `event_schema_test.exs` | 30 | Event schema compliance |
| `spec_validation_test.exs` | 6 | Spec file syntax validation |

### CI/CD Integration

Specification validation runs automatically on every push:

```yaml
# .github/workflows/spec-validation.yml
- name: Validate OpenAPI spec
  run: npx redocly lint spec/openapi/configapi-v1.yaml

- name: Validate AsyncAPI spec
  run: npx asyncapi validate spec/asyncapi/config-events-v1.yaml

- name: Validate JSON schemas
  run: npm run validate:json-schema

- name: Run contract tests
  run: mix test test/spec/ --only integration
```

## API Versioning

### URL Path Versioning

ConfigApi uses explicit URL versioning for API stability:

- **Current version:** `v1`
- **Base path:** `/v1/*`
- **Legacy support:** Unversioned routes (`/config`) deprecated

### Version Migration

```bash
# Deprecated (v0, backward compatibility only)
GET /config
PUT /config/api_key

# Current (v1, recommended)
GET /v1/config
PUT /v1/config/api_key

# Future (v2, breaking changes)
GET /v2/config
PUT /v2/config/api_key
```

### Deprecation Timeline

| Version | Status | Support |
|---------|--------|---------|
| v0 (unversioned) | Deprecated | Until v2.0 release |
| v1 | Current | Active development |
| v2 | Planned | Breaking changes |

## Integration Examples

### Import into Postman

1. Open Postman
2. Click **Import** → **File**
3. Select `spec/openapi/configapi-v1.yaml`
4. Postman creates a collection with all endpoints

### Import into Insomnia

1. Open Insomnia
2. **Import/Export** → **Import Data** → **From File**
3. Select `spec/openapi/configapi-v1.yaml`
4. Insomnia creates workspace with endpoints

### Swagger UI (Docker)

```bash
docker run -p 8080:8080 \
  -v $(pwd)/spec/openapi:/spec \
  -e SWAGGER_JSON=/spec/configapi-v1.yaml \
  swaggerapi/swagger-ui

# Open http://localhost:8080
```

### Schema Registry Integration

JSON schemas can be registered in Confluent Schema Registry:

```bash
# Register ConfigValueSet event schema
curl -X POST http://localhost:8081/subjects/config-value-set/versions \
  -H "Content-Type: application/vnd.schemaregistry.v1+json" \
  --data @spec/json-schema/events/config-value-set.json
```

## Best Practices

### 1. Keep Specifications in Sync

- **Update specs** when changing API implementation
- **Run contract tests** before committing
- **Validate specs** in CI/CD pipeline

### 2. Use Semantic Versioning

- **PATCH** (1.0.x): Bug fixes, backward compatible
- **MINOR** (1.x.0): New features, backward compatible
- **MAJOR** (x.0.0): Breaking changes, new API version

### 3. Document CQRS Patterns

- Use `x-cqrs-pattern` to indicate command/query
- Specify `x-aggregate` for domain ownership
- Document `x-generates-event` for event sourcing

### 4. Provide Comprehensive Examples

- Include success and error examples
- Show edge cases and validation errors
- Provide curl commands for testing

### 5. Validate Before Commit

```bash
# Pre-commit validation script
npx redocly lint spec/openapi/configapi-v1.yaml
npx asyncapi validate spec/asyncapi/config-events-v1.yaml
npm run validate:json-schema
mix test test/spec/
```

## Extending the Specifications

### Adding a New Endpoint

1. **Create path definition:** `spec/openapi/paths/my-endpoint.yaml`
2. **Add request/response schemas:** `spec/openapi/schemas/`
3. **Reference from main spec:** Update `configapi-v1.yaml`
4. **Add examples:** Create comprehensive examples
5. **Write contract tests:** `test/spec/openapi_contract_test.exs`
6. **Validate:** `npx redocly lint spec/openapi/configapi-v1.yaml`

### Adding a New Event

1. **Create JSON schema:** `spec/json-schema/events/my-event.json`
2. **Add to AsyncAPI:** Update `spec/asyncapi/config-events-v1.yaml`
3. **Implement event struct:** `lib/config_api/events/my_event.ex`
4. **Update aggregate:** Generate event in response to command
5. **Update projection:** Handle event in projection
6. **Write tests:** `test/spec/event_schema_test.exs`

### Modifying Existing Schemas

1. **Consider versioning:** Breaking change? → New API version
2. **Update schema files:** Modify YAML/JSON schemas
3. **Update examples:** Reflect new schema in examples
4. **Update tests:** Match tests to new schema
5. **Run validation:** Ensure no breaking changes
6. **Regenerate docs:** Update generated documentation

## Troubleshooting

### Specification Validation Fails

```bash
# Check syntax errors
npx redocly lint spec/openapi/configapi-v1.yaml --format=stylish

# Check for broken references
npx redocly lint spec/openapi/configapi-v1.yaml --skip-rule=no-unused-components

# Validate JSON syntax
cat spec/json-schema/events/config-value-set.json | jq .
```

### Contract Tests Fail

```bash
# Run with detailed output
mix test test/spec/openapi_contract_test.exs --trace

# Check if API implementation changed
curl -s http://localhost:4000/v1/config | jq .

# Verify server is running
curl -s http://localhost:4000/v1/health
```

### Documentation Generation Fails

```bash
# Check Node.js version (requires >= 20)
node --version

# Try with different template
npx redocly build-docs spec/openapi/configapi-v1.yaml --template=classic

# Clear npm cache
npm cache clean --force
rm -rf node_modules package-lock.json
npm install
```

### React Version Conflicts

```bash
# The package.json includes React overrides
# If you encounter "Invalid hook call" errors:

# 1. Clean install
rm -rf node_modules package-lock.json
npm install

# 2. Verify overrides are applied
npm list react react-dom
# Should show react@18.3.1 and react-dom@18.3.1
```

## Resources

### Standards Documentation

- [OpenAPI 3.1.0 Specification](https://spec.openapis.org/oas/v3.1.0)
- [JSON Schema 2020-12](https://json-schema.org/draft/2020-12/json-schema-core.html)
- [AsyncAPI 3.0.0 Specification](https://www.asyncapi.com/docs/reference/specification/v3.0.0)

### Tools

- [Redocly CLI](https://redocly.com/docs/cli/) - OpenAPI validation and docs
- [AsyncAPI CLI](https://www.asyncapi.com/docs/tools/cli) - AsyncAPI tools
- [AJV](https://ajv.js.org/) - JSON Schema validator
- [OpenAPI Generator](https://openapi-generator.tech/) - Client code generation

### ConfigApi Documentation

- [API Documentation](./docs/api/rest-api.md)
- [Architecture Guide](./docs/architecture/cqrs-implementation.md)
- [Detailed Spec Guide](./spec/README.md)
- [CQRS Implementation](./CLAUDE.md#architecture)

## Support

For specification-related questions:

1. **Check the specs:** Review specification files in `spec/` directory
2. **Run examples:** Test with provided curl commands
3. **Contract tests:** Run `mix test test/spec/` to see expected behavior
4. **Documentation:** Read the comprehensive [spec/README.md](./spec/README.md)
5. **GitHub Issues:** Open an issue for bugs or questions

---

**Last Updated:** 2026-02-13
**Specification Version:** 1.0.0
**API Version:** v1
